(function(){var e,t,n;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),t=require("jquery"),window.jQuery=t,window.moment=require("moment"),require("kuende-livestamp"),n=require("opentok-solutions-logging")):(e=this._,t=this.$,window.jQuery=t,window.moment=this.moment,n=this.OTKAnalytics);var s,i,a,o,r,c,d,l,m={clientVersion:"js-vsol-1.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionStart:"Start",actionEnd:"End",actionOpen:"OpenTC",actionClose:"CloseTC",actionSendMessage:"Send Msg",actionReceiveMessage:"Receive Msg",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},u=function(){var e=window.location.href,t={clientVersion:m.clientVersion,source:e,componentId:m.componentId,name:m.name};a=new n(t);var s={sessionId:i.id,connectionId:i.connection.connectionId,partnerId:i.apiKey};a.addSessionInfo(s)},g=function(e,t){var n={action:e,variation:t};a.logEvent(n)},v=!1,h=!1,p=!1,f=!1,w=[],C=!1,y=function(e,t){l&&l.triggerEvent(e,t)},x=function(){return['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-messages-alert hidden" id="messagesWaiting">Messsages will be delivered once your contact arrives</div>','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+s.options.limitCharacterMessage+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="characterCount">0</span>/'+s.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},S=function(e){return!!c&&(c.sender.id===e.sender.id&&c.sender.id===e.sender.id)},M=function(){r.value="",t("#characterCount").text("0")},E=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},T=function(e,n,s,i){var a=o.id===e?"wms-message-item wms-message-sent":"wms-message-item",r=E({username:n,message:s,messageClass:a,time:i}),c=t(d);c.append(r),M(),c[0].scrollTop=c[0].scrollHeight},I=function(e){if(S(e)){t(".wms-item-text").last().append(["<span>",e.message,"</span>"].join(""));var n=t(d);n[0].scrollTop=n[0].scrollHeight,M()}else T(o.id,o.alias,e.message,e.sentOn);c=e,y("messageSent",e)},k=function(n){if(console.log(n.code,n.message),500===n.code){var i=e.template(t("#chatError").html());t(s.comms_elements.messagesView).append(i())}y("errorSendingMessage",n)},b=function(n,s){var a=new t.Deferred;w.push({recipient:n,message:s}),C||(j(),a.resolve());var r={text:s,sender:{id:o.id,alias:o.alias},sentOn:Date.now()};return g(m.actionSendMessage,m.variationAttempt),void 0===n?i.signal({type:"text-chat",data:JSON.stringify(r)},function(t){if(t){var n="Error sending a message. ";g(m.actionSendMessage,m.variationFailure),413===t.code?n+="The chat message is over size limit.":500===t.code&&(n+="Check your network connection."),a.reject(e.extend(e.omit(t,"message")),{message:n})}else console.log("Message sent"),g(m.actionSendMessage,m.variationSuccess),a.resolve(r)}):i.signal({type:"text-chat",data:JSON.stringify(r),to:n},function(e){e?(console.log("Error sending a message"),g(m.actionSendMessage,m.variationFailure),a.resolve(e)):(console.log("Message sent"),a.resolve(r),g(m.actionSendMessage,m.variationSuccess))}),a.promise()},L=function(n){e.isEmpty(n)||t.when(b(s._remoteParticipant,n)).then(function(){I({sender:{id:o.id,alias:o.alias},message:n,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){k(e)})},j=function(){var e=document.getElementById("messagesWaiting");e&&e.classList.remove("hidden")},q=function(){var e=document.getElementById("messagesWaiting");e&&e.classList.add("hidden")},O=function(){var e=document.querySelector(s.options.textChatContainer)||document.body,n=document.createElement("section");n.innerHTML=x(),r=n.querySelector("#messageBox"),d=n.querySelector("#messagesHolder"),r.onkeyup=function(){t("#characterCount").text(r.value.length)},r.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),L(r.value))},e.appendChild(n),document.getElementById("sendMessage").onclick=function(){L(r.value)},g(m.actionInitialize,m.variationSuccess)},A=function(e){var n=JSON.parse(e.data);S(n)?t(".wms-item-text").last().append(["<span>",n.text,"</span>"].join("")):T(n.sender.id,n.sender.alias,n.text,n.sentOn),c=n,g(m.actionReceiveMessage,m.variationSuccess)},D=function(e){var t=i.connection.connectionId,n=e.from.connectionId;if(n!==t){var s=A(e);s&&"function"==typeof s&&s(e),y("messageReceived",e)}},H=function(){w.forEach(function(e){b(e.recipient,e.message)}),w=[]},P=function(e){e.from.connectionId!==i.connection.connectionId&&(C=!0,H())},B=function(){var e={type:"text-chat-ready",data:JSON.stringify({ready:!0})};i.on("signal:text-chat-ready",P),i.signal(e,function(e){e&&console.log("Error sending ready signal",e)})},N=function(){v=!0,h=!0,p=!0,O(),y("showTextChat"),i.on("signal:text-chat",D),B(),g(m.actionStart,m.variationSuccess)},R=function(){document.querySelector(s.options.textChatContainer).classList.remove("hidden"),h=!0,y("showTextChat"),g(m.actionOpen,m.variationSuccess)},_=function(){document.querySelector(s.options.textChatContainer).classList.add("hidden"),h=!1,y("hideTextChat"),g(m.actionClose,m.variationSuccess),g(m.actionEnd,m.variationSuccess)},J=function(){var e=document.querySelector(s.options.controlsContainer),t=document.createElement("div");t.innerHTML='<div class="video-control circle text-chat enabled" id="enableTextChat"></div>';var n=t.firstChild;e.appendChild(n),f=!0,n.onclick=function(){p?h?_():R():N()}},V=function(t){if(!t.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},s=function(){return[n(),i.id,n()].join("")};return i=e.property("session")(t),l=e.property("accPack")(t),o=e.defaults(t.sender||{},{id:s(),alias:["User",n()].join(" ")}),e.defaults(e.omit(t,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer"})},W=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];l&&l.registerEvents(e)},z=function(e){e&&e.stream.connection.connectionId!==i.connection.connectionId&&(C=!0,q())},F=function(){i.streams.length()<2&&(C=!1)},K=function(){l?(l.registerEventListener("streamCreated",z),l.registerEventListener("streamDestroyed",F),l.registerEventListener("startCall",function(){f?document.querySelector("#enableTextChat").classList.remove("hidden"):J()}),l.registerEventListener("endCall",function(){document.getElementById("enableTextChat").classList.add("hidden"),h&&_()})):(i.on("streamCreated",z),i.on("streamDestroyed",F)),z()},Q=function(t){s=this,s.options=V(t),u(),e.property("_this.options.limitCharacterMessage")(t)&&g(m.actionSetMaxLength,m.variationSuccess),J(),W(),K()};Q.prototype={constructor:Q,isEnabled:function(){return v},isDisplayed:function(){return h},showTextChat:function(){R()},hideTextChat:function(){_()}},"object"==typeof exports?module.exports=Q:"function"==typeof define&&define.amd?define(function(){return Q}):this.TextChatAccPack=Q}).call(this);