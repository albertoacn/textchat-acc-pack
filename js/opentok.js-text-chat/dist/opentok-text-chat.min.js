(function(){var e=function(e){var t="object"==typeof exports&&void 0!==require;if(t)return require(e);throw new Error(["Please include",e,"in your project"].join(" "))},t=this._||e("underscore"),n=this.$||e("jquery");global.jQuery=n;var i,s,a,o,r,c,d,l,m=(this.moment||e("moment"),this.livestamp||t.require("kuende-livestamp"),this.OTKAnalytics||e("opentok-solutions-logging")),u={clientVersion:"js-vsol-1.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionSendMessage:"SendMessage",actionReceiveMessage:"ReceiveMessage",actionMaximize:"Maximize",actionMinimize:"Minimize",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},v=function(){var e=window.location.href,t={clientVersion:u.clientVersion,source:e,componentId:u.componentId,name:u.name};a=new m(t);var n={sessionId:s.id,connectionId:s.connection.connectionId,partnerId:s.apiKey};a.addSessionInfo(n)},g=function(e,t){var n={action:e,variation:t};a.logEvent(n)},h=!1,p=!1,f=!1,x=!1,w=function(e,t){l&&l.triggerEvent(e,t)},C=function(){return['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+i.options.limitCharacterMessage+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="characterCount">0</span>/'+i.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},M=function(e){return!!c&&(c.sender.id===e.sender.id&&c.sender.id===e.sender.id)},y=function(){r.value="",n("#characterCount").text("0")},S=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},T=function(e,t,i,s){var a=o.id===e?"wms-message-item wms-message-sent":"wms-message-item",r=S({username:t,message:i,messageClass:a,time:s}),c=n(d);c.append(r),y(),c[0].scrollTop=c[0].scrollHeight},E=function(e){if(M(e)){n(".wms-item-text").last().append(["<span>",e.message,"</span>"].join(""));var t=n(d);t[0].scrollTop=t[0].scrollHeight,y()}else T(o.id,o.alias,e.message,e.sentOn);c=e,w("messageSent",e)},k=function(e){if(console.log(e.code,e.message),500===e.code){var s=t.template(n("#chatError").html());n(i.comms_elements.messagesView).append(s())}w("errorSendingMessage",e)},I=function(e,i){var a=new n.Deferred,r={text:i,sender:{id:o.id,alias:o.alias},sentOn:Date.now()};return g(u.actionSendMessage,u.variationAttempt),void 0===e?s.signal({type:"text-chat",data:JSON.stringify(r)},function(e){if(e){var n="Error sending a message. ";g(u.actionSendMessage,u.variationFailure),413===e.code?n+="The chat message is over size limit.":500===e.code&&(n+="Check your network connection."),a.reject(t.extend(t.omit(e,"message")),{message:n})}else console.log("Message sent"),g(u.actionSendMessage,u.variationSuccess),a.resolve(r)}):s.signal({type:"text-chat",data:JSON.stringify(r),to:e},function(e){e?(console.log("Error sending a message"),g(u.actionSendMessage,u.variationFailure),a.resolve(e)):(console.log("Message sent"),a.resolve(r),g(u.actionSendMessage,u.variationSuccess))}),a.promise()},b=function(e){t.isEmpty(e)||n.when(I(i._remoteParticipant,e)).then(function(){E({sender:{id:o.id,alias:o.alias},message:e,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){k(e)})},j=function(){var e=document.querySelector(i.options.textChatContainer)||document.body,t=document.createElement("section");t.innerHTML=C(),r=t.querySelector("#messageBox"),d=t.querySelector("#messagesHolder"),r.onkeyup=function(){n("#characterCount").text(r.value.length)},r.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),b(r.value))},e.appendChild(t),document.getElementById("sendMessage").onclick=function(){b(r.value)},g(u.actionInitialize,u.variationSuccess)},A=function(e){g(u.actionReceiveMessage,u.variationAttempt);var t=JSON.parse(e.data);M(t)?n(".wms-item-text").last().append(["<span>",t.text,"</span>"].join("")):T(t.sender.id,t.sender.alias,t.text,t.sentOn),c=t,g(u.actionReceiveMessage,u.variationSuccess)},q=function(e){var t=s.connection.connectionId,n=e.from.connectionId;if(n!==t){var i=A(e);i&&"function"==typeof i&&i(e),w("messageReceived",e)}},z=function(){g(u.actionInitialize,u.variationAttempt),h=!0,p=!0,f=!0,j(),w("showTextChat"),s.on("signal:text-chat",q)},L=function(){g(u.actionMaximize,u.variationAttempt),document.querySelector(i.options.textChatContainer).classList.remove("hidden"),p=!0,w("showTextChat"),g(u.actionMaximize,u.variationSuccess)},O=function(){g(u.actionMinimize,u.variationAttempt),document.querySelector(i.options.textChatContainer).classList.add("hidden"),p=!1,w("hideTextChat"),g(u.actionMinimize,u.variationSuccess)},P=function(){var e=document.querySelector(i.options.controlsContainer),t=document.createElement("div");t.innerHTML='<div class="video-control circle text-chat enabled" id="enableTextChat"></div>';var n=t.firstChild;e.appendChild(n),x=!0,n.onclick=function(){f?p?O():L():z()}},H=function(e){if(!e.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},i=function(){return[n(),s.id,n()].join("")};return s=t.property("session")(e),l=t.property("accPack")(e),o=t.defaults(e.sender||{},{id:i(),alias:["User",n()].join(" ")}),t.defaults(t.omit(e,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer"})},D=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];l&&l.registerEvents(e)},R=function(){l&&(l.registerEventListener("startCall",function(){x?document.querySelector("#enableTextChat").classList.remove("hidden"):P()}),l.registerEventListener("endCall",function(){document.getElementById("enableTextChat").classList.add("hidden"),p&&O()}))},N=function(e){i=this,i.options=H(e),v(),t.property("_this.options.limitCharacterMessage")(e)&&(g(u.actionSetMaxLength,u.variationAttempt),g(u.actionSetMaxLength,u.variationSuccess)),P(),D(),R()};N.prototype={constructor:N,isEnabled:function(){return h},isDisplayed:function(){return p},showTextChat:function(){L()},hideTextChat:function(){O()}},"object"==typeof exports?module.exports=N:"function"==typeof define&&define.amd?define(function(){return N}):this.TextChatAccPack=N}).call(this);