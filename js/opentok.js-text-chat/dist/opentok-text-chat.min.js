(function(){var e,t,n;"object"==typeof module&&"object"==typeof module.exports?(e=require("underscore"),t=require("jquery"),window.jQuery=t,window.moment=require("moment"),require("kuende-livestamp"),n=require("opentok-solutions-logging")):(e=this._,t=this.$,window.jQuery=t,window.moment=this.moment,n=this.OTKAnalytics);var i,s,a,o,r,c,d,m,l={clientVersion:"js-vsol-1.0.0",componentId:"textChatAccPack",name:"guidTextChatAccPack",actionInitialize:"Init",actionSendMessage:"SendMessage",actionReceiveMessage:"ReceiveMessage",actionMaximize:"Maximize",actionMinimize:"Minimize",actionSetMaxLength:"SetMaxLength",variationAttempt:"Attempt",variationError:"Failure",variationSuccess:"Success"},u=function(){var e=window.location.href,t={clientVersion:l.clientVersion,source:e,componentId:l.componentId,name:l.name};a=new n(t);var i={sessionId:s.id,connectionId:s.connection.connectionId,partnerId:s.apiKey};a.addSessionInfo(i)},v=function(e,t){var n={action:e,variation:t};a.logEvent(n)},g=!1,h=!1,p=!1,f=!1,w=function(e,t){m&&m.triggerEvent(e,t)},x=function(){return['<div class="wms-widget-wrapper">','<div class="wms-widget-chat wms-widget-extras" id="chatContainer">','<div class="wms-messages-header hidden" id="chatHeader">',"<span>Chat with</span>","</div>",'<div id="wmsChatWrap">','<div class="wms-messages-holder" id="messagesHolder">','<div class="wms-message-item wms-message-sent">',"</div>","</div>",'<div class="wms-send-message-box">','<input type="text" maxlength='+i.options.limitCharacterMessage+' class="wms-message-input" placeholder="Enter your message here" id="messageBox">','<button class="wms-icon-check" id="sendMessage" type="submit"></button>','<div class="wms-character-count"><span><span id="characterCount">0</span>/'+i.options.limitCharacterMessage+" characters</span></div>","</div>","</div>","</div>","</div>"].join("\n")},C=function(e){return!!c&&(c.sender.id===e.sender.id&&c.sender.id===e.sender.id)},y=function(){r.value="",t("#characterCount").text("0")},M=function(e){var t=['<div class="'+e.messageClass+'" >','<div class="wms-user-name-initial"> '+e.username[0]+"</div>",'<div class="wms-item-timestamp"> '+e.username+', <span data-livestamp=" '+new Date(e.time)+'" </span></div>','<div class="wms-item-text">',"<span> "+e.message+"</span>","</div>","</div>"].join("\n");return t},S=function(e,n,i,s){var a=o.id===e?"wms-message-item wms-message-sent":"wms-message-item",r=M({username:n,message:i,messageClass:a,time:s}),c=t(d);c.append(r),y(),c[0].scrollTop=c[0].scrollHeight},T=function(e){if(C(e)){t(".wms-item-text").last().append(["<span>",e.message,"</span>"].join(""));var n=t(d);n[0].scrollTop=n[0].scrollHeight,y()}else S(o.id,o.alias,e.message,e.sentOn);c=e,w("messageSent",e)},k=function(n){if(console.log(n.code,n.message),500===n.code){var s=e.template(t("#chatError").html());t(i.comms_elements.messagesView).append(s())}w("errorSendingMessage",n)},E=function(n,i){var a=new t.Deferred,r={text:i,sender:{id:o.id,alias:o.alias},sentOn:Date.now()};return v(l.actionSendMessage,l.variationAttempt),void 0===n?s.signal({type:"text-chat",data:JSON.stringify(r)},function(t){if(t){var n="Error sending a message. ";v(l.actionSendMessage,l.variationFailure),413===t.code?n+="The chat message is over size limit.":500===t.code&&(n+="Check your network connection."),a.reject(e.extend(e.omit(t,"message")),{message:n})}else console.log("Message sent"),v(l.actionSendMessage,l.variationSuccess),a.resolve(r)}):s.signal({type:"text-chat",data:JSON.stringify(r),to:n},function(e){e?(console.log("Error sending a message"),v(l.actionSendMessage,l.variationFailure),a.resolve(e)):(console.log("Message sent"),a.resolve(r),v(l.actionSendMessage,l.variationSuccess))}),a.promise()},I=function(n){e.isEmpty(n)||t.when(E(i._remoteParticipant,n)).then(function(){T({sender:{id:o.id,alias:o.alias},message:n,sentOn:Date.now()}),this.futureMessageNotice&&(this.futureMessageNotice=!1)},function(e){k(e)})},b=function(){var e=document.querySelector(i.options.textChatContainer)||document.body,n=document.createElement("section");n.innerHTML=x(),r=n.querySelector("#messageBox"),d=n.querySelector("#messagesHolder"),r.onkeyup=function(){t("#characterCount").text(r.value.length)},r.onkeydown=function(e){var t=13===e.which||13===e.keyCode;!e.shiftKey&&t&&(e.preventDefault(),I(r.value))},e.appendChild(n),document.getElementById("sendMessage").onclick=function(){I(r.value)},v(l.actionInitialize,l.variationSuccess)},j=function(e){v(l.actionReceiveMessage,l.variationAttempt);var n=JSON.parse(e.data);C(n)?t(".wms-item-text").last().append(["<span>",n.text,"</span>"].join("")):S(n.sender.id,n.sender.alias,n.text,n.sentOn),c=n,v(l.actionReceiveMessage,l.variationSuccess)},q=function(e){var t=s.connection.connectionId,n=e.from.connectionId;if(n!==t){var i=j(e);i&&"function"==typeof i&&i(e),w("messageReceived",e)}},A=function(){v(l.actionInitialize,l.variationAttempt),g=!0,h=!0,p=!0,b(),w("showTextChat"),s.on("signal:text-chat",q)},z=function(){v(l.actionMaximize,l.variationAttempt),document.querySelector(i.options.textChatContainer).classList.remove("hidden"),h=!0,w("showTextChat"),v(l.actionMaximize,l.variationSuccess)},L=function(){v(l.actionMinimize,l.variationAttempt),document.querySelector(i.options.textChatContainer).classList.add("hidden"),h=!1,w("hideTextChat"),v(l.actionMinimize,l.variationSuccess)},O=function(){var e=document.querySelector(i.options.controlsContainer),t=document.createElement("div");t.innerHTML='<div class="video-control circle text-chat enabled" id="enableTextChat"></div>';var n=t.firstChild;e.appendChild(n),f=!0,n.onclick=function(){p?h?L():z():A()}},H=function(t){if(!t.session)throw new Error("Text Chat Accelerator Pack requires an OpenTok session.");var n=function(e){var t=e||3;return Math.random().toString(36).substr(2,t)},i=function(){return[n(),s.id,n()].join("")};return s=e.property("session")(t),m=e.property("accPack")(t),o=e.defaults(t.sender||{},{id:i(),alias:["User",n()].join(" ")}),e.defaults(e.omit(t,["accPack","_sender"]),{limitCharacterMessage:160,controlsContainer:"#feedControls",textChatContainer:"#chatContainer"})},P=function(){var e=["showTextChat","hideTextChat","messageSent","errorSendingMessage","messageReceived"];m&&m.registerEvents(e)},D=function(){m&&(m.registerEventListener("startCall",function(){f?document.querySelector("#enableTextChat").classList.remove("hidden"):O()}),m.registerEventListener("endCall",function(){document.getElementById("enableTextChat").classList.add("hidden"),h&&L()}))},R=function(t){i=this,i.options=H(t),u(),e.property("_this.options.limitCharacterMessage")(t)&&(v(l.actionSetMaxLength,l.variationAttempt),v(l.actionSetMaxLength,l.variationSuccess)),O(),P(),D()};R.prototype={constructor:R,isEnabled:function(){return g},isDisplayed:function(){return h},showTextChat:function(){z()},hideTextChat:function(){L()}},"object"==typeof exports?module.exports=R:"function"==typeof define&&define.amd?define(function(){return R}):this.TextChatAccPack=R}).call(this);